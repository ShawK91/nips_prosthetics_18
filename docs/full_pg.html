<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>full_pg.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>full_pg.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">core</span> <span class="kn">import</span> <span class="n">off_policy_gradient</span> <span class="k">as</span> <span class="n">pg</span>
<span class="kn">from</span> <span class="nn">core</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">core.mod_utils</span> <span class="kn">import</span> <span class="n">list_mean</span><span class="p">,</span> <span class="n">pprint</span>
<span class="kn">import</span> <span class="nn">core.reward_shaping</span> <span class="kn">as</span> <span class="nn">rs</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">core</span> <span class="kn">import</span> <span class="n">mod_utils</span> <span class="k">as</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">core.runner</span> <span class="kn">import</span> <span class="n">rollout_worker</span>
<span class="kn">import</span> <span class="nn">core.ounoise</span> <span class="kn">as</span> <span class="nn">OU_handle</span>
<span class="kn">from</span> <span class="nn">torch.multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Pipe</span><span class="p">,</span> <span class="n">Manager</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;3&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>MACROS</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">SEED</span> <span class="o">=</span> <span class="bp">True</span> <span class="c1">#Load seed actor/critic from models/</span>
<span class="n">SEED_CHAMP</span> <span class="o">=</span> <span class="bp">False</span> <span class="c1">#Seed using models/erl_best (neuroevolution&#39;s out)</span>
<span class="n">SAVE_RS</span> <span class="o">=</span> <span class="bp">False</span> <span class="c1">#When reward shaping is on, whether to save the best shaped performer or the tru best performer</span>
<span class="n">SAVE_THRESHOLD</span> <span class="o">=</span> <span class="mi">500</span> <span class="c1">#Threshold for saving best policies</span>
<span class="n">QUICK_TEST</span> <span class="o">=</span> <span class="bp">True</span> <span class="c1">#DEBUG MODE</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>Parameter class stores all parameters for policy gradient</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Parameters</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>Parameters:
    None</p>
<p>Returns:
    None</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>FAIRLY STATIC</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">num_action_rollouts</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1">#Controls how many runners it used to perform parallel rollouts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_cuda</span><span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algo</span> <span class="o">=</span> <span class="s1">&#39;TD3&#39;</span>    <span class="c1">#1. TD3</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <ol>
<li>DDPG</li>
</ol>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="mi">1991</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span> <span class="c1">#Batch size for learning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.95</span> <span class="c1">#Discount rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="mf">0.001</span> <span class="c1">#Target network soft-update rate</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">use_advantage</span> <span class="o">=</span> <span class="bp">True</span> <span class="c1">#Use Advantage Function (Q-V)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_done_mask</span> <span class="o">=</span> <span class="bp">True</span> <span class="c1">#Use done mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_w</span> <span class="o">=</span> <span class="bp">False</span> <span class="c1">#Whether to initialize model weights using Kaimiling Ne</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>Policy Gradient steps</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">iter_per_epoch</span> <span class="o">=</span> <span class="mi">200</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>TD3</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">policy_ups_freq</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1">#Number of Critic updates per actor update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policy_noise</span> <span class="o">=</span> <span class="mf">0.03</span> <span class="c1">#Noise in policy output when computing Bellman update (smoothes the Critic)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policy_noise_clip</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1">#Hard clip for ^^^</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <h6>## REWARD SHAPING</h6>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>Temporal Reward Shaping (flowing reward backward across a trajectory)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">rs_done_w</span> <span class="o">=</span> <span class="o">-</span><span class="mf">50.0</span> <span class="c1">#Penalty for the last transition that leads to falling (except within the last timestep)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rs_proportional_shape</span> <span class="o">=</span> <span class="bp">True</span> <span class="c1">#Flow the done_penalty backwards through the trajectory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done_gamma</span><span class="o">=</span> <span class="mf">0.9</span> <span class="c1">#Discount factor for flowing back the done_penalty</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>Behavioral Reward Shaping (rs to encode behavior constraints)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">use_behavior_rs</span> <span class="o">=</span> <span class="bp">False</span> <span class="c1">#Use behavioral reward shaping</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_behavior_rs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">footz_w</span><span class="o">=</span> <span class="o">-</span><span class="mf">5.0</span> <span class="c1">#No foot criss-crossing the z-axis</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kneefoot_w</span> <span class="o">=</span> <span class="o">-</span><span class="mf">7.5</span> <span class="c1">#Knee remains in front of foot plus the tibia is always bend backward</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pelv_w</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.0</span> <span class="c1">#Pelvis is below 0.8m (crouched)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">footy_w</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1">#Foot is below 0.1m (don&#39;t raise foot too high)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">head_w</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.0</span> <span class="c1">#Head is behind the pelvis in x</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>Trust-region Constraints</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">critic_constraint</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">critic_constraint_w</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_clamp</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policy_constraint</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policy_constraint_w</span> <span class="o">=</span> <span class="bp">None</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>Target Networks</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">hard_update_freq</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hard_update</span> <span class="o">=</span> <span class="bp">False</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>Action loss (entropy analogy for continous action space)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">action_loss</span> <span class="o">=</span> <span class="bp">False</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_loss_w</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span> <span class="o">=</span> <span class="mi">415</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_dim</span> <span class="o">=</span> <span class="mi">19</span> <span class="c1">#HARDCODED FOR THIS PROBLEM</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>Save Results</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">save_foldername</span> <span class="o">=</span> <span class="s1">&#39;R_Skeleton/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_foldername</span> <span class="o">+</span> <span class="s1">&#39;metrics/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_foldername</span> <span class="o">+</span> <span class="s1">&#39;models/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rl_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_foldername</span> <span class="o">+</span> <span class="s1">&#39;rl_models/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_foldername</span> <span class="o">+</span> <span class="s1">&#39;data/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aux_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_foldername</span> <span class="o">+</span> <span class="s1">&#39;auxiliary/&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_foldername</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_foldername</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_save</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_save</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rl_models</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rl_models</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_folder</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_folder</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aux_save</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aux_save</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">critic_fname</span> <span class="o">=</span> <span class="s1">&#39;td3_critic&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">algo</span> <span class="o">==</span> <span class="s1">&#39;TD3&#39;</span> <span class="k">else</span> <span class="s1">&#39;ddpg_critic&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actor_fname</span> <span class="o">=</span> <span class="s1">&#39;td3_actor&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">algo</span> <span class="o">==</span> <span class="s1">&#39;TD3&#39;</span> <span class="k">else</span> <span class="s1">&#39;ddpg_actor&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_fname</span> <span class="o">=</span> <span class="s1">&#39;td3_epoch&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">algo</span> <span class="o">==</span> <span class="s1">&#39;TD3&#39;</span> <span class="k">else</span> <span class="s1">&#39;ddpg_epoch&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_fname</span> <span class="o">=</span> <span class="s1">&#39;td3_best&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">algo</span> <span class="o">==</span> <span class="s1">&#39;TD3&#39;</span> <span class="k">else</span> <span class="s1">&#39;ddpg_best&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>Memory Object loads and stores experience tuples from the drive. Similar to Buffer except that memory refers to old buffers (generated by a different learner and stored in disk)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Memory</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <pre><code>Parameters:
    capacity (int): Maximum number of experiences to load
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">capacity</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="p">[];</span> <span class="bp">self</span><span class="o">.</span><span class="n">ns</span> <span class="o">=</span> <span class="p">[];</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="p">[];</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="p">[];</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_entries</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loaded_files</span> <span class="o">=</span> <span class="p">[]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_entries</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>Sample a batch of experiences from memory with uniform probability</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <pre><code>Parameters:
    batch_size (int): Size of the batch to sample
    args (object): Parameter class

Returns:
    Experience (tuple): A tuple of (state, next_state, action, reward, done) each as a numpy array with shape (batch_size, :)
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">ind</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()),</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>Load experiences from drive</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_folder</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <pre><code>Parameters:
    data_folder (str): Folder to load data from

Returns:
    None
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <h6># READ DATA</h6>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">list_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_folder</span><span class="p">)</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_files</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span> <span class="k">continue</span> <span class="c1">#Wait for Data indefinitely</span>
        <span class="k">print</span> <span class="p">(</span><span class="n">list_files</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="nb">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">list_files</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_files</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data_folder</span> <span class="o">+</span> <span class="nb">file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loaded_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">];</span> <span class="n">ns</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;next_state&#39;</span><span class="p">];</span> <span class="n">a</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">];</span> <span class="n">r</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">];</span> <span class="n">done_dist</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;done_dist&#39;</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>Reward Shaping for premature falling</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">rs_proportional_shape</span><span class="p">:</span>
                    <span class="n">rs_flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">done_dist</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#All tuples which lead to premature convergence</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>r[rs_flag] = r[rs_flag] - ((DONE_GAMMA ** done_dist[rs_flag]) * abs(r[rs_flag]))</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="n">r</span><span class="p">[</span><span class="n">rs_flag</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">rs_flag</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">done_gamma</span> <span class="o">**</span> <span class="n">done_dist</span><span class="p">[</span><span class="n">rs_flag</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">rs_done_w</span>  <span class="c1"># abs(r[rs_flag]))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rs_flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">done_dist</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">done_dist</span><span class="p">))</span> <span class="c1">#All tuple which was the last experience in premature convergence</span>
                    <span class="n">r</span><span class="p">[</span><span class="n">rs_flag</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">rs_done_w</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <h6>####### BEHAVIORAL REWARD SHAPE</h6>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">use_behavior_rs</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">shaped_data</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">footz_w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">kneefoot_w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">prlv_w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">footy_w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">head_w</span><span class="p">)</span>



                <span class="n">done</span> <span class="o">=</span> <span class="p">(</span><span class="n">done_dist</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">ns</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">a</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">r</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">done</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">s</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ns</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">ns</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">a</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">r</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">done</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">num_entries</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">QUICK_TEST</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;######## DEBUG MODE ########&#39;</span><span class="p">)</span>
                    <span class="k">break</span>


        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;BUFFER LOADED WITH&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_entries</span><span class="p">,</span> <span class="s1">&#39;SAMPLES&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>self.s = self.s.pin_memory()
self.ns = self.ns.pin_memory()
self.a = self.a.pin_memory()
self.r = self.r.pin_memory()
self.done = self.done.pin_memory()</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>Cyclic Buffer stores experience tuples from the rollouts</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Buffer</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      <pre><code>Parameters:
    save_freq (int): Period for saving data to drive
    save_folder (str): Folder to save data to
    capacity (int): Maximum number of experiences to hold in cyclic buffer
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_freq</span><span class="p">,</span> <span class="n">save_folder</span><span class="p">,</span> <span class="n">capacity</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_freq</span> <span class="o">=</span> <span class="n">save_freq</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">=</span> <span class="n">save_folder</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="mi">1000000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="p">[];</span> <span class="bp">self</span><span class="o">.</span><span class="n">ns</span> <span class="o">=</span> <span class="p">[];</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="p">[];</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="p">[];</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_dist</span> <span class="o">=</span> <span class="p">[];</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="p">[];</span> <span class="bp">self</span><span class="o">.</span><span class="n">shaped_r</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <p>Add an experience to the buffer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">done_dist</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">shaped_r</span><span class="p">):</span> <span class="c1">#f: FITNESS, t: TIMESTEP, done: DONE</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      <pre><code>Parameters:
    s (ndarray): Current State
    ns (ndarray): Next State
    a (ndarray): Action
    r (ndarray): Reward
    done_dist (ndarray): Temporal distance to done (#action steps after which the skselton fell over)
    done (ndarray): Done
    shaped_r (ndarray): Shaped Reward (includes both temporal and behavioral shaping)


Returns:
    None
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_dist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">shaped_r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      <p>Append new tuple</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">ns</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_dist</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">done_dist</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">shaped_r</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">shaped_r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      <p>Sample a batch of experiences from memory with uniform probability</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <pre><code>   Parameters:
       batch_size (int): Size of the batch to sample

   Returns:
       Experience (tuple): A tuple of (state, next_state, action, shaped_reward, done) each as a numpy array with shape (batch_size, :)
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">ind</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()),</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">shaped_r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">done_dist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      <p>Method to save experiences to drive</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <pre><code>   Parameters:
       None

   Returns:
       None
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">tag</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_freq</span><span class="p">))</span>

        <span class="n">end_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span>
        <span class="n">start_ind</span> <span class="o">=</span> <span class="n">end_ind</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_freq</span>

        <span class="n">np</span><span class="o">.</span><span class="n">savez_compressed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;pg_data_&#39;</span> <span class="o">+</span> <span class="n">tag</span><span class="p">,</span>
                            <span class="n">state</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="n">start_ind</span><span class="p">:</span><span class="n">end_ind</span><span class="p">]),</span>
                            <span class="n">next_state</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">[</span><span class="n">start_ind</span><span class="p">:</span><span class="n">end_ind</span><span class="p">]),</span>
                            <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">start_ind</span><span class="p">:</span><span class="n">end_ind</span><span class="p">]),</span>
                            <span class="n">reward</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">start_ind</span><span class="p">:</span><span class="n">end_ind</span><span class="p">]),</span>
                            <span class="n">done_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">done_dist</span><span class="p">[</span><span class="n">start_ind</span><span class="p">:</span><span class="n">end_ind</span><span class="p">]),</span>
                            <span class="n">done</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">[</span><span class="n">start_ind</span><span class="p">:</span><span class="n">end_ind</span><span class="p">]))</span>
        <span class="k">print</span> <span class="p">(</span><span class="s1">&#39;MEMORY BUFFER WITH INDEXES&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_ind</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">end_ind</span><span class="p">),</span>  <span class="s1">&#39;SAVED WITH TAG&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      <p>Policy Gradient Algorithm main object which carries out off-policy learning using policy gradient</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">PG_ALGO</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <p>Encodes all functionalities for 1. TD3 2. DDPG 3.Trust-region TD3/DDPG 4. Advantage TD3/DDPG</p>
<pre><code>    Parameters:
        args (int): Parameter class with all the parameters
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rl_agent</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">TD3_DDPG</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_rlagent</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">TD3_DDPG</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      <p>Use seed to bootstrap learning</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">SEED</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">SEED_CHAMP</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;R_Skeleton/models/erl_best&#39;</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">actor_target</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;R_Skeleton/models/erl_best&#39;</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">new_rlagent</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;R_Skeleton/models/erl_best&#39;</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">new_rlagent</span><span class="o">.</span><span class="n">actor_target</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;R_Skeleton/models/erl_best&#39;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">rl_models</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">best_fname</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">actor_target</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">rl_models</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">best_fname</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">new_rlagent</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">rl_models</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">best_fname</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">new_rlagent</span><span class="o">.</span><span class="n">actor_target</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">rl_models</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">best_fname</span><span class="p">))</span>

                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Actor successfully loaded from the R_Skeleton folder for&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">best_fname</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Loading Actors failed&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">critic_target</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">model_save</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">critic_fname</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">critic</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">model_save</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">critic_fname</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new_rlagent</span><span class="o">.</span><span class="n">critic_target</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">model_save</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">critic_fname</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new_rlagent</span><span class="o">.</span><span class="n">critic</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">model_save</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">critic_fname</span><span class="p">))</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Critic successfully loaded from the R_Skeleton folder for&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">critic_fname</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span> <span class="k">print</span> <span class="p">(</span><span class="s1">&#39;Loading Critics failed&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      <p>Load to GPU</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">actor_target</span><span class="o">.</span><span class="n">cuda</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">critic_target</span><span class="o">.</span><span class="n">cuda</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">critic</span><span class="o">.</span><span class="n">cuda</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_rlagent</span><span class="o">.</span><span class="n">actor_target</span><span class="o">.</span><span class="n">cuda</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_rlagent</span><span class="o">.</span><span class="n">critic_target</span><span class="o">.</span><span class="n">cuda</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_rlagent</span><span class="o">.</span><span class="n">critic</span><span class="o">.</span><span class="n">cuda</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_rlagent</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      <h6>##### LOAD DATA AND CONSTRUCT GENERATORS</h6>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">Memory</span><span class="p">(</span><span class="mi">10000000</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">data_folder</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      <h5>Buffer is agent&rsquo;s own data self generated via its rollouts</h5>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">replay_buffer</span> <span class="o">=</span> <span class="n">Buffer</span><span class="p">(</span><span class="n">save_freq</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span> <span class="n">save_folder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">data_folder</span><span class="p">,</span> <span class="n">capacity</span><span class="o">=</span><span class="mi">1000000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_gen</span> <span class="o">=</span> <span class="n">OU_handle</span><span class="o">.</span><span class="n">get_list_generators</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_action_rollouts</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">action_dim</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      <h6>## Multiprocessing TOOLS</h6>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exp_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">list</span><span class="p">()</span> <span class="c1">#Experience list stores experiences from all processes</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      <h6># TEST ROLLOUT POLICY</h6>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">test_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">list</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_policy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Actor</span><span class="p">(</span><span class="n">args</span><span class="p">));</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_policy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Actor</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_task_pipes</span> <span class="o">=</span> <span class="p">[</span><span class="n">Pipe</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_action_rollouts</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_result_pipes</span> <span class="o">=</span> <span class="p">[</span><span class="n">Pipe</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_action_rollouts</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_worker</span> <span class="o">=</span> <span class="p">[</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">rollout_worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_task_pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_result_pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_policy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SAVE_RS</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_worker</span><span class="p">:</span> <span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      <h6>## TRAIN ROLLOUTS WITH ACTION NOISE</h6>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">rollout_pop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">num_action_rollouts</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollout_pop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Actor</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_pipes</span> <span class="o">=</span> <span class="p">[</span><span class="n">Pipe</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_action_rollouts</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_pipes</span> <span class="o">=</span> <span class="p">[</span><span class="n">Pipe</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_action_rollouts</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_workers</span> <span class="o">=</span> <span class="p">[</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">rollout_worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_gen</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollout_pop</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="n">SAVE_RS</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_action_rollouts</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_workers</span><span class="p">:</span> <span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      <h3>STATS AND TRACKING WHICH ROLLOUT IS DONE</h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">best_policy</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Actor</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="c1">#Best policy found by PF yet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_added</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_len</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">];</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_score</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">];</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_action_noise_score</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_agent_scores</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_noise_scores</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_action_rollouts</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_eval_flag</span> <span class="o">=</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_eval_flag</span> <span class="o">=</span> <span class="p">[</span><span class="bp">True</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_action_rollouts</span><span class="p">)]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-51'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-51'>#</a>
      </div>
      <p>Process and send experiences to be added to the buffer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">add_experience</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done_dist</span><span class="p">,</span> <span class="n">done</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-52'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-52'>#</a>
      </div>
      <pre><code>  Parameters:
      state (ndarray): Current State
      next_state (ndarray): Next State
      action (ndarray): Action
      reward (ndarray): Reward
      done_dist (ndarray): Temporal distance to done (#action steps after which the skselton fell over)
      done (ndarray): Done
      shaped_r (ndarray): Shaped Reward (includes both temporal and behavioral shaping)

  Returns:
      None
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_added</span> <span class="o">+=</span> <span class="mi">1</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-53'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-53'>#</a>
      </div>
      <p>RS to GENERATE SHAPED_REWARD</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">shaped_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">rs_proportional_shape</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">done_dist</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">shaped_r</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reward</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">done_gamma</span> <span class="o">**</span> <span class="n">done_dist</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">rs_done_w</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">done_dist</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">shaped_r</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">rs_done_w</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">use_behavior_rs</span><span class="p">:</span> <span class="n">shaped_r</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">shaped_data</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">shaped_r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">footz_w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">kneefoot_w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">pelv_w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">footy_w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">head_w</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">replay_buffer</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done_dist</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">shaped_r</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_added</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">replay_buffer</span><span class="o">.</span><span class="n">save_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">replay_buffer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-54'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-54'>#</a>
      </div>
      <p>Main training loop to do rollouts and run policy gradients</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gen</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-55'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-55'>#</a>
      </div>
      <pre><code>Parameters:
    gen (int): Current epoch of training

Returns:
    None
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">gen</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">data_folder</span><span class="p">)</span> <span class="c1">#Reload memory</span>
        <span class="k">if</span> <span class="n">gen</span> <span class="o">%</span> <span class="mi">2000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_policy</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;R_Skeleton/models/erl_best&#39;</span><span class="p">))</span> <span class="c1">#Referesh best policy</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-56'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-56'>#</a>
      </div>
      <h6>#### START TEST ROLLOUT</h6>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_eval_flag</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="c1">#ALL DATA TEST</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_eval_flag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">hard_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_policy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">actor</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_task_pipes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_eval_flag</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># Iterative RL Learner (New RL Agent)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_eval_flag</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_rlagent</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_rlagent</span><span class="o">.</span><span class="n">hard_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_policy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_rlagent</span><span class="o">.</span><span class="n">actor</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_rlagent</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_task_pipes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-57'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-57'>#</a>
      </div>
      <h6>### START TRAIN (ACTION NOISE) ROLLOUTS</h6>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">num_action_rollouts</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_eval_flag</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_eval_flag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-58'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-58'>#</a>
      </div>
      <p>HALF ACTION ROLLOUT ON BEST POLICY WHILE THE OTHER HALF ON CURRENT POLICY</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">hard_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rollout_pop</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_policy</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">hard_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rollout_pop</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">actor</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">new_rlagent</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">new_rlagent</span><span class="o">.</span><span class="n">hard_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rollout_pop</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_rlagent</span><span class="o">.</span><span class="n">actor</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">new_rlagent</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">task_pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-59'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-59'>#</a>
      </div>
      <h6>####################### RL LEANRING DURING POPULATION EVALUATION</h6>
<p>TRAIN FROM MEMORY (PREVIOUS DATA) for RL AGENT</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">iter_per_epoch</span><span class="p">):</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
            <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">cuda</span><span class="p">();</span> <span class="n">ns</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">cuda</span><span class="p">();</span> <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">cuda</span><span class="p">();</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">cuda</span><span class="p">();</span> <span class="n">done</span> <span class="o">=</span> <span class="n">done</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">num_epoch</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-60'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-60'>#</a>
      </div>
      <h1>TRAIN FROM SELF_GENERATED DATA FOR NEW_RL_AGENT</h1>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">replay_buffer</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">:</span> <span class="c1">#BURN IN PERIOD</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">iter_per_epoch</span><span class="o">/</span><span class="mi">2</span><span class="p">)):</span>
                <span class="n">s</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">shaped_r</span><span class="p">,</span> <span class="n">done_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replay_buffer</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>

                <span class="n">done</span> <span class="o">=</span> <span class="p">(</span><span class="n">done_dist</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="n">ns</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span> <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
                <span class="n">shaped_r</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">shaped_r</span><span class="p">);</span> <span class="n">done</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">done</span><span class="p">)</span>

                <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">cuda</span><span class="p">();</span> <span class="n">ns</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">cuda</span><span class="p">();</span> <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">cuda</span><span class="p">();</span> <span class="n">shaped_r</span><span class="o">=</span><span class="n">shaped_r</span><span class="o">.</span><span class="n">cuda</span><span class="p">();</span> <span class="n">done</span> <span class="o">=</span> <span class="n">done</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new_rlagent</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">shaped_r</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">num_epoch</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-61'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-61'>#</a>
      </div>
      <h6>######################### EO POLICY GRSDIENT</h6>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-62'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-62'>#</a>
      </div>
      <p>Save critic periodically</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">gen</span> <span class="o">%</span> <span class="mi">200</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">QUICK_TEST</span> <span class="o">!=</span> <span class="bp">True</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">QUICK_TEST</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-63'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-63'>#</a>
      </div>
      <p>torch.save(self.rl_agent.actor.state_dict(), parameters.rl_models + actor_fname)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">critic</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">parameters</span><span class="o">.</span><span class="n">model_save</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">critic_fname</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Critic Saved periodically&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-64'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-64'>#</a>
      </div>
      <h4>PROCESS TEST ROLLOUT</h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_result_pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">poll</span><span class="p">():</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_result_pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test_eval_flag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test_score</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test_len</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_score</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_score</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">best_agent_scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_score</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span> <span class="o">&gt;</span> <span class="n">SAVE_THRESHOLD</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">hard_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_policy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_policy</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">QUICK_TEST</span><span class="p">:</span>
                            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_policy</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">parameters</span><span class="o">.</span><span class="n">rl_models</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">best_fname</span><span class="p">)</span>
                            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Best policy saved with score &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span><span class="p">,</span> <span class="s1">&#39;originated from RL_Agent Index &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-65'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-65'>#</a>
      </div>
      <h6>PROCESS TRAIN ROLLOUTS</h6>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">num_action_rollouts</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">poll</span><span class="p">():</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_eval_flag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">action_noise_scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_action_noise_score</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">best_action_noise_score</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-66'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-66'>#</a>
      </div>
      <p>Add ALL EXPERIENCE COLLECTED TO MEMORY concurrently</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_list</span><span class="p">)):</span>
            <span class="n">exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_list</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_experience</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">exp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">exp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">exp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">exp</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-67'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-67'>#</a>
      </div>
      <p>Helper function to manipulate strings for setting save filenames that reflect the parameters</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">shape_filename</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-68'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-68'>#</a>
      </div>
      <pre><code>  Parameters:
    fname (str): Filename
    args (object): Parameter class

  Returns:
      fname (str): New filename
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">gamma</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">rs_proportional_shape</span><span class="p">:</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;RS_PROP&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">done_gamma</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span>
    <span class="n">fname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">rs_done_w</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">use_advantage</span><span class="p">:</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;_ADV&#39;</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">use_behavior_rs</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">footz_w</span><span class="p">)</span><span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">kneefoot_w</span><span class="p">)</span><span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pelv_w</span><span class="p">)</span><span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">footy_w</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fname</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">()</span>  <span class="c1"># Create the Parameters class</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-69'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-69'>#</a>
      </div>
      <h6>############# PRCOESS FILENAMES TO SAVE PROGRESS</h6>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">parameters</span><span class="o">.</span><span class="n">critic_fname</span> <span class="o">=</span> <span class="n">shape_filename</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">critic_fname</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
    <span class="n">parameters</span><span class="o">.</span><span class="n">actor_fname</span> <span class="o">=</span> <span class="n">shape_filename</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">actor_fname</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
    <span class="n">parameters</span><span class="o">.</span><span class="n">log_fname</span> <span class="o">=</span> <span class="n">shape_filename</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">log_fname</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
    <span class="n">parameters</span><span class="o">.</span><span class="n">best_fname</span> <span class="o">=</span> <span class="n">shape_filename</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">best_fname</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-70'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-70'>#</a>
      </div>
      <h6></h6>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-71'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-71'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">frame_tracker</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">Tracker</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">metric_save</span><span class="p">,</span> <span class="p">[</span><span class="n">parameters</span><span class="o">.</span><span class="n">log_fname</span><span class="o">+</span><span class="s1">&#39;_1&#39;</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">log_fname</span><span class="o">+</span><span class="s1">&#39;_2&#39;</span><span class="p">],</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>  <span class="c1"># Initiate tracker</span>
    <span class="n">ml_tracker</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">Tracker</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">aux_save</span><span class="p">,</span> <span class="p">[</span><span class="n">parameters</span><span class="o">.</span><span class="n">log_fname</span><span class="o">+</span><span class="s1">&#39;critic_loss&#39;</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">log_fname</span><span class="o">+</span><span class="s1">&#39;policy_loss&#39;</span><span class="p">],</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>  <span class="c1"># Initiate tracker</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">seed</span><span class="p">);</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">seed</span><span class="p">);</span> <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>    <span class="c1">#Seeds</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-72'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-72'>#</a>
      </div>
      <p>INITIALIZE THE MAIN AGENT CLASS</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">agent</span> <span class="o">=</span> <span class="n">PG_ALGO</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Running&#39;</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">algo</span><span class="p">,</span>  <span class="s1">&#39; State_dim:&#39;</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">state_dim</span><span class="p">,</span> <span class="s1">&#39; Action_dim:&#39;</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">action_dim</span><span class="p">,</span> <span class="s1">&#39;using Data&#39;</span><span class="p">)</span>
    <span class="n">time_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">();</span> <span class="n">num_frames</span> <span class="o">=</span> <span class="mf">0.0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-73'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-73'>#</a>
      </div>
      <h5>TRAINING LOOP</h5>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000000000</span><span class="p">):</span> <span class="c1">#RUN VIRTUALLY FOREVER</span>
        <span class="n">gen_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-74'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-74'>#</a>
      </div>
      <p>ONE EPOCH OF TRAINING</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">agent</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-75'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-75'>#</a>
      </div>
      <p>PRINT PROGRESS</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Ep:&#39;</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="s1">&#39;Score cur/best:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">pprint</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">test_score</span><span class="p">],</span> <span class="n">pprint</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">best_score</span><span class="p">),</span>
              <span class="s1">&#39;Time:&#39;</span><span class="p">,</span><span class="n">pprint</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">gen_time</span><span class="p">),</span> <span class="s1">&#39;Len&#39;</span><span class="p">,</span> <span class="n">pprint</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">test_len</span><span class="p">),</span> <span class="s1">&#39;Best_action_noise_score&#39;</span><span class="p">,</span> <span class="n">pprint</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">best_action_noise_score</span><span class="p">),</span> <span class="s1">&#39;Best_Agent_scores&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">pprint</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">best_agent_scores</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-76'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-76'>#</a>
      </div>
      <p>PRINT MORE DETAILED STATS PERIODICALLY</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#Special Stats</span>
            <span class="k">print</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;#Data_Created&#39;</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">buffer_added</span><span class="p">,</span> <span class="s1">&#39;Q_Val Stats&#39;</span><span class="p">,</span> <span class="n">pprint</span><span class="p">(</span><span class="n">list_mean</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">])),</span> <span class="n">pprint</span><span class="p">(</span><span class="n">list_mean</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">])),</span> <span class="n">pprint</span><span class="p">(</span><span class="n">list_mean</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">])),</span>
              <span class="s1">&#39;Val Stats&#39;</span><span class="p">,</span> <span class="n">pprint</span><span class="p">(</span><span class="n">list_mean</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">])),</span> <span class="n">pprint</span><span class="p">(</span><span class="n">list_mean</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">])),</span> <span class="n">pprint</span><span class="p">(</span><span class="n">list_mean</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">])))</span>
            <span class="k">print</span><span class="p">()</span>
            <span class="k">print</span> <span class="p">(</span><span class="s1">&#39;Memory_size/mil&#39;</span><span class="p">,</span> <span class="n">pprint</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">num_entries</span><span class="o">/</span><span class="mf">1000000.0</span><span class="p">),</span> <span class="s1">&#39;Algo:&#39;</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">best_fname</span><span class="p">,</span>
                   <span class="s1">&#39;Gamma&#39;</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
                   <span class="s1">&#39;RS_PROP&#39;</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">rs_proportional_shape</span><span class="p">,</span>
                   <span class="s1">&#39;ADVANTAGE&#39;</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">use_advantage</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Action Noise Rollouts: &#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">pprint</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">action_noise_scores</span><span class="p">])</span>
            <span class="k">print</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Critic_loss mean:&#39;</span><span class="p">,</span> <span class="n">pprint</span><span class="p">(</span><span class="n">list_mean</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">critic_loss</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">])),</span>
              <span class="s1">&#39;Policy_loss Stats:&#39;</span><span class="p">,</span> <span class="n">pprint</span><span class="p">(</span><span class="n">list_mean</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">policy_loss</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">])),</span>
              <span class="n">pprint</span><span class="p">(</span><span class="n">list_mean</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">policy_loss</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">])),</span>
              <span class="n">pprint</span><span class="p">(</span><span class="n">list_mean</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">policy_loss</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">])),</span>
              <span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Critic_loss mean_new:&#39;</span><span class="p">,</span> <span class="n">pprint</span><span class="p">(</span><span class="n">list_mean</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">new_rlagent</span><span class="o">.</span><span class="n">critic_loss</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">])),</span>
              <span class="s1">&#39;Policy_loss_new Stats:&#39;</span><span class="p">,</span> <span class="n">pprint</span><span class="p">(</span><span class="n">list_mean</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">new_rlagent</span><span class="o">.</span><span class="n">policy_loss</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">])),</span>
              <span class="n">pprint</span><span class="p">(</span><span class="n">list_mean</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">new_rlagent</span><span class="o">.</span><span class="n">policy_loss</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">])),</span>
              <span class="n">pprint</span><span class="p">(</span><span class="n">list_mean</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">new_rlagent</span><span class="o">.</span><span class="n">policy_loss</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">])),</span>
              <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-77'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-77'>#</a>
      </div>
      <p>if agent.rl_agent.action_loss[&lsquo;min&rsquo;] != None:
    print(&lsquo;Action_loss Stats&rsquo;, pprint(list_mean(agent.rl_agent.action_loss[&lsquo;min&rsquo;])),
         pprint(list_mean(agent.rl_agent.action_loss[&lsquo;max&rsquo;])),
         pprint(list_mean(agent.rl_agent.action_loss[&lsquo;mean&rsquo;])),
         pprint(list_mean(agent.rl_agent.action_loss[&lsquo;std&rsquo;])))</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">print</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-78'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-78'>#</a>
      </div>
      <p>Update score to trackers</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">frame_tracker</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">agent</span><span class="o">.</span><span class="n">test_score</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">agent</span><span class="o">.</span><span class="n">test_score</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">epoch</span><span class="p">)</span>
        <span class="n">ml_tracker</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">agent</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">critic_loss</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">agent</span><span class="o">.</span><span class="n">rl_agent</span><span class="o">.</span><span class="n">policy_loss</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">epoch</span><span class="p">)</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
